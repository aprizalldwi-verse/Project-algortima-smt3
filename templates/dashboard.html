{% extends "base.html" %}
{% block content %}

<h2 class="page-title">Dashboard Statistik Mahasiswa</h2>

<div class="dashboard-grid">

    <div class="card">
        <h3>Total Mahasiswa</h3>
        <p class="value">{{ total }}</p>
    </div>

    <div class="card">
        <h3>Rata-rata IPK</h3>
        <p class="value">{{ avg_ipk }}</p>
    </div>

    <div class="card wide">
        <h3>Jumlah Per Jurusan</h3>
        <ul class="jurusan-list">
            {% for j, count in per_jurusan.items() %}
                <li>{{ j }}: <strong>{{ count }}</strong></li>
            {% endfor %}
        </ul>
    </div>

</div>

<!-- ===== CHART AREA ===== -->
<div class="dashboard-grid">
    <div class="card wide">
        <h3>Grafik Jumlah Mahasiswa per Jurusan</h3>

        <!-- ukuran dikontrol inline biar aman -->
        <div style="max-width:380px;margin:30px auto;">
            <canvas id="donutChart"></canvas>
        </div>

        <div style="margin-top:40px;">
            <canvas id="barChart"></canvas>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const dataJurusan = JSON.parse('{{ per_jurusan | tojson | safe }}');
    const labels = Object.keys(dataJurusan);
    const values = Object.values(dataJurusan);

    const total = values.reduce((a, b) => a + b, 0);
    const percentValues = values.map(v => ((v / total) * 100).toFixed(1));

    /* ===== DONUT CHART + % DI TENGAH ===== */
    new Chart(document.getElementById("donutChart"), {
        type: "doughnut",
        data: {
            labels: labels,
            datasets: [{
                data: percentValues,
                backgroundColor: [
                    "#6366f1",
                    "#22c55e",
                    "#f97316",
                    "#ef4444",
                    "#14b8a6",
                    "#eab308",
                    "#8b5cf6"
                ],
                cutout: "65%" // ðŸ‘ˆ lubang tengah (donut)
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: "bottom" },
                tooltip: {
                    callbacks: {
                        label: ctx => `${ctx.label}: ${ctx.raw}%`
                    }
                }
            }
        },
        plugins: [{
            id: 'centerText',
            afterDraw(chart) {
                const { ctx } = chart;
                const centerX = chart.getDatasetMeta(0).data[0].x;
                const centerY = chart.getDatasetMeta(0).data[0].y;

                ctx.save();
                ctx.font = "bold 22px Poppins";
                ctx.fillStyle = "#6366f1";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText("100%", centerX, centerY);
                ctx.restore();
            }
        }]
    });

    /* ===== BAR CHART (PERSENTASE) ===== */
    new Chart(document.getElementById("barChart"), {
        type: "bar",
        data: {
            labels: labels,
            datasets: [{
                label: "Persentase Mahasiswa (%)",
                data: percentValues,
                backgroundColor: "#6366f1"
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: v => v + "%"
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: ctx => ctx.raw + "%"
                    }
                }
            }
        }
    });
</script>

{% endblock %}
